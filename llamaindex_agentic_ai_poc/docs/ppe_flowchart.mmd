%% PPE compliance workflow flow chart
%% Generated by GPT-5.1 Codex on 2025-11-17

flowchart TD
    U[Ops portal / camera stream] -->|base64 image| A[ImageUploadedEvent]

    subgraph WorkflowServer["PPE Workflow Server"]
        A --> B[analyse_image step]
        B -->|store request + session key| ST[(Workflow state)]
        B -->|load memory| M[(ContextProvider.get_memory)]
        M -->|vector recall| PG[(PGVector + Postgres)]
        B --> C[ppe_risk_analyser tool]
        C -->|YOLO best.pt| Y[YOLO detections]
        Y -->|classes| D{Any PPE violation?}
        D -->|No| N["StopEvent: No issues found"]
        D -->|Yes| E[handle_ppe_violations step]
        E --> M2[(Memory + Request context)]
        E --> FA[FunctionAgent image_analyser]
    end

    subgraph Tools["Tooling layer"]
        FA -->|calls| MCP[MCP client get_tools_from_mcp_server]
        MCP --> Srv[FastMCP Server]
        Srv --> IR[incident_recorder tool]
        IR --> INC[(Incident log / UUID list)]
    end

    IR -->|incident_id| FA
    FA -->|response| E
    E -->|return enriched request| ST
    E --> F["StopEvent: incident payload"]

    C -->|async| LL[llama_index FunctionTool wrapper]
    FA -->|LLM reasoning| LLM[(Ollama-hosted LLM)]
    ContextProvider -.-> PG
    ContextProvider -.-> M

    classDef store fill:#fdf5d6,stroke:#d4ad37,color:#333;
    classDef tool fill:#e6f2ff,stroke:#5290d8,color:#1b3c74;
    class ST,PG,INC store;
    class MCP,Srv,IR tool;

